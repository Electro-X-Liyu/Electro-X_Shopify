{{ 'section-Community.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* 确保图片容器有固定宽高比 */
  .community-card__image-wrapper {
    position: relative;
    overflow: hidden;
  }
  
  .community-card__image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
  }
  
  .community-card__image:hover {
    transform: scale(1.03);
  }
{%- endstyle -%}

{%- liquid
  assign show_mobile_slider = true
  if section.settings.swipe_on_mobile and section.blocks.size > 1
    assign show_mobile_slider = true
  endif
-%}

<div class="community color-{{ section.settings.color_scheme }} gradient">
  <div class="page-width section-{{ section.id }}-padding isolate">
    {%- unless section.settings.title == blank -%}
      <div class="title-wrapper-with-link title-wrapper--self-padded-mobile title-wrapper--no-top-margin community__title">
        <h2 class="title inline-richtext {{ section.settings.heading_size }}">
          {{ section.settings.title | escape }}
        </h2>
      </div>
    {%- endunless -%}

    <slider-component class="slider-mobile-gutter">
      <ul class="community-list contains-content-container grid grid--1-col-tablet-down grid--{{ section.settings.columns_desktop }}-col-desktop{% if show_mobile_slider %} slider slider--tablet grid--peek{% endif %}" id="Slider-{{ section.id }}" role="list">
        {%- for block in section.blocks -%}
          {%- liquid
            assign mobile_image_width = section.settings.mobile_image_width | default: 500
            assign desktop_image_width = section.settings.desktop_image_width | default: 800
            assign image_aspect_ratio = block.settings.image.aspect_ratio | default: 1
          -%}
          <li id="Slide-{{ section.id }}-{{ forloop.index }}" class="community-list__item grid__item{% if show_mobile_slider %} slider__slide{% endif %}" {{ block.shopify_attributes }}>
            <div class="community-card content-container">
              {%- if block.settings.image != blank -%}
                <div class="community-card__image-wrapper" style="padding-bottom: {{ 100 | divided_by: image_aspect_ratio }}%;">
                  <a href="{{ block.settings.image | image_url: width: 2000 }}" class="community-card__image-link" data-fslightbox="community-gallery-{{ section.id }}">
                    <img
                      srcset="
                        {{ block.settings.image | image_url: width: mobile_image_width }} {{ mobile_image_width }}w,
                        {{ block.settings.image | image_url: width: desktop_image_width }} {{ desktop_image_width }}w
                      "
                      src="{{ block.settings.image | image_url: width: desktop_image_width }}"
                      sizes="(max-width: 749px) {{ mobile_image_width }}px, {{ desktop_image_width }}px"
                      alt="{{ block.settings.image.alt | escape }}"
                      loading="lazy"
                      class="community-card__image"
                      width="{{ desktop_image_width }}"
                      height="{{ desktop_image_width | divided_by: image_aspect_ratio | round }}"
                    >
                  </a>
                </div>
              {%- else -%}
                <div class="community-card__image-wrapper" style="padding-bottom: 100%; background: #f5f5f5;">
                  {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {%- endif -%}
              <div class="community-card__info">
                {%- if block.settings.title != blank -%}
                  <h3 class="inline-richtext">{{ block.settings.title }}</h3>
                {%- endif -%}
                {%- if block.settings.text != blank -%}
                  <div class="rte">{{ block.settings.text }}</div>
                {%- endif -%}
              </div>
            </div>
          </li>
        {%- endfor -%}
      </ul>

      {%- if show_mobile_slider -%}
        <div class="slider-buttons large-up-hide">
          <button type="button" class="slider-button slider-button--prev" name="previous" aria-label="{{ 'general.slider.previous_slide' | t }}">
            {% render 'icon-caret' %}
          </button>
          <div class="slider-counter caption">
            <span class="slider-counter--current">1</span>
            <span aria-hidden="true"> / </span>
            <span class="visually-hidden">{{ 'general.slider.of' | t }}</span>
            <span class="slider-counter--total">{{ section.blocks.size }}</span>
          </div>
          <button type="button" class="slider-button slider-button--next" name="next" aria-label="{{ 'general.slider.next_slide' | t }}">
            {% render 'icon-caret' %}
          </button>
        </div>
      {%- endif -%}
    </slider-component>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 确保只初始化一次
    if (typeof FsLightbox === 'function' && !document.querySelector('[data-fslightbox="community-gallery-{{ section.id }}"]_initialized')) {
      const lightbox = new FsLightbox();
      lightbox.props.sources = Array.from(document.querySelectorAll('[data-fslightbox="community-gallery-{{ section.id }}"]')).map(el => el.href);
      document.querySelector('[data-fslightbox="community-gallery-{{ section.id }}"]').setAttribute('data-fslightbox-initialized', 'true');
    }
  });
</script>